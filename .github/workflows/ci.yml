# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python ÐºÐ¾Ð´Ð° Ð¸ Ñ‚ÐµÑÑ‚Ñ‹
  test-python:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ðŸ” Run Python tests
      run: |
        echo "Running tests..."
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=html
    
    - name: ðŸ“Š Upload test coverage
      uses: actions/upload-artifact@v3
      with:
        name: test-coverage
        path: htmlcov/
    
    - name: ðŸ“„ Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          coverage.xml
          .coverage

  # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker ÑÐ±Ð¾Ñ€ÐºÐ¸
  build-docker:
    runs-on: ubuntu-latest
    needs: test-python
    if: github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: ðŸ”¨ Build Docker image
      run: |
        docker build -t library-system:${{ github.sha }} .
        docker build -t library-system:latest .
    
    - name: ðŸ§ª Test Docker image
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ
        docker run --rm library-system:latest python -c "import sys; print('âœ… Python works'); from app.config import settings; print(f'âœ… Config loaded: {settings.APP_NAME}')"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ FastAPI Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚
        docker run --rm library-system:latest python -c "from app.main import app; print('âœ… FastAPI app loaded')"
    
    - name: ðŸ“¦ Save Docker image
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: |
          Dockerfile
          docker-compose.yml
          requirements.txt

  # 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° API (Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹)
  test-api:
    runs-on: ubuntu-latest
    needs: test-python
    timeout-minutes: 5
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸš€ Start API server
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€ Ð² Ñ„Ð¾Ð½Ðµ
        nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        echo "Server starting..."
        sleep 5
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
        if ! curl -s http://localhost:8000/api/health > /dev/null; then
          echo "âŒ Server failed to start"
          cat server.log
          exit 1
        fi
        echo "âœ… Server started successfully"
    
    - name: ðŸ” Test API endpoints
      run: |
        echo "Testing API endpoints..."
        
        # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹
        endpoints=(
          "/api/health"
          "/api/books"
          "/api/readers" 
          "/api/copies"
          "/api/loans"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Testing $endpoint..."
          if curl -f "http://localhost:8000$endpoint"; then
            echo "âœ… $endpoint OK"
          else
            echo "âŒ $endpoint FAILED"
            exit 1
          fi
          echo "---"
        done
        
        echo "ðŸŽ‰ All API endpoints work!"
    
    - name: ðŸ“„ Save server logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: server-logs
        path: server.log

  # 4. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  summary:
    runs-on: ubuntu-latest
    needs: [test-python, build-docker, test-api]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate summary
      run: |
        echo "# ðŸŽ‰ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Jobs Status:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Python Tests: ${{ needs.test-python.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker Build: ${{ needs.build-docker.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… API Tests: ${{ needs.test-api.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "- Docker Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Server Logs" >> $GITHUB_STEP_SUMMARY
# .github/workflows/cd.yml
name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ³ Build and push to Docker Hub
      if: github.event_name == 'push' || github.event.inputs.deploy == 'true'
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ Ð² Docker Hub (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ credentials)
        if [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ]; then
          echo "Logging in to Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð¿ÑƒÑˆÐ¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·
          docker build -t $DOCKER_USERNAME/library-system:latest .
          docker push $DOCKER_USERNAME/library-system:latest
          
          echo "âœ… Image pushed to Docker Hub"
        else
          echo "âš ï¸ Docker Hub credentials not set, skipping push"
          echo "Building local image only..."
          docker build -t library-system:latest .
        fi
    
    - name: ðŸ“¦ Generate deployment package
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
        mkdir -p deploy-package
        cp -r app/ deploy-package/
        cp requirements.txt deploy-package/
        cp Dockerfile deploy-package/
        cp docker-compose.yml deploy-package/
        cp .env.example deploy-package/.env
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°
        cat > deploy-package/start.sh << 'EOF'
        #!/bin/bash
        echo "Starting Library System..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
        python -m venv venv
        source venv/bin/activate
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        pip install -r requirements.txt
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€
        uvicorn app.main:app --host 0.0.0.0 --port 8000
        EOF
        
        chmod +x deploy-package/start.sh
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README
        cat > deploy-package/README.md << 'EOF'
        # Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÑ‡Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°
        
        ## Ð—Ð°Ð¿ÑƒÑÐº
        
        ### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð§ÐµÑ€ÐµÐ· Python
        ```bash
        ./start.sh
        ```
        
        ### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð§ÐµÑ€ÐµÐ· Docker
        ```bash
        docker-compose up -d
        ```
        
        ## Ð”Ð¾ÑÑ‚ÑƒÐ¿
        - Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ: http://localhost:8000
        - API Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: http://localhost:8000/docs
        ```
        
        zip -r deploy-package.zip deploy-package/
    
    - name: ðŸ“¤ Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: deploy-package
        path: deploy-package.zip
    
    - name: ðŸ“Š Deployment summary
      run: |
        echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- Docker image built" >> $GITHUB_STEP_SUMMARY
        echo "- Deployment package generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Next steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download deploy-package artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract and run ./start.sh" >> $GITHUB_STEP_SUMMARY
        echo "3. Or use Docker: docker-compose up -d" >> $GITHUB_STEP_SUMMARY
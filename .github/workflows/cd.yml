name: CD (staged)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build:
    name: Build Docker image (no push)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: ghcr.io/${{ github.repository }}:latest

      - name: Save image artifact (best-effort)
        run: |
          IMAGE=ghcr.io/${{ github.repository }}:latest
          docker save $IMAGE -o image.tar || true

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar

  deploy:
    name: Simulated deployment (stub)
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Simulate deployment
        run: |
          echo "Simulating deployment to production..."
          echo "Deployed commit $GITHUB_SHA on $(date)" > deploy.log

      - name: Upload deploy log
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy.log

# .github/workflows/release.yml
name: Create Release

on:
  push:
    tags: [ 'v*' ]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Generate documentation
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        pip install -r requirements.txt
        
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
        python -c "
        import json
        from app.main import app
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ OpenAPI ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ
        with open('openapi.json', 'w') as f:
            json.dump(app.openapi(), f, indent=2, ensure_ascii=False)
        "
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
        cat > RELEASE_NOTES.md << 'EOF'
        # Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÑ‡Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° ${{ github.ref_name }}
        
        ## ðŸš€ ÐÐ¾Ð²Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
        
        ### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸:
        - Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð°Ð¼Ð¸ Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼Ð¸
        - Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸
        - Ð’Ñ‹Ð´Ð°Ñ‡Ð° Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ ÐºÐ½Ð¸Ð³
        - ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² Ð¸ ÑÑ€Ð¾ÐºÐ¾Ð²
        
        ### Ð¢ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÑ‚ÐµÐº:
        - FastAPI 0.104+
        - SQLAlchemy 2.0+
        - Pydantic 2.5+
        - PostgreSQL/SQLite
        
        ## ðŸ³ Docker
        ```bash
        docker pull ${{ secrets.DOCKER_USERNAME }}/library-system:${{ github.ref_name }}
        docker-compose up -d
        ```
        
        ## ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
        - API: http://localhost:8000/docs
        - ReDoc: http://localhost:8000/redoc
        
        ## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
        ```bash
        pytest tests/ -v
        ```
        EOF

    - name: Upload OpenAPI specification
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./openapi.json
        asset_name: openapi.json
        asset_content_type: application/json

    - name: Upload Docker-compose config
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./docker-compose.yml
        asset_name: docker-compose.yml
        asset_content_type: text/yaml

    - name: Upload requirements
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./requirements.txt
        asset_name: requirements.txt
        asset_content_type: text/plain
# .github/workflows/release.yml
name: Release

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ·ï¸ Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: ðŸ“¦ Prepare release files
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
        mkdir -p release
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        cp -r app/ release/
        cp requirements.txt release/
        cp Dockerfile release/
        cp docker-compose.yml release/
        cp .env.example release/.env
        cp README.md release/
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
        cat > release/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing Library System v$VERSION..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python
        if ! command -v python3 &> /dev/null; then
            echo "Python 3 not found. Installing..."
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
        python3 -m venv venv
        source venv/bin/activate
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        pip install -r requirements.txt
        
        echo "âœ… Installation complete!"
        echo "Run: source venv/bin/activate && uvicorn app.main:app --reload"
        EOF
        
        chmod +x release/install.sh
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ CHANGELOG
        cat > release/CHANGELOG.md << EOF
        # Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÑ‡Ð½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° v$VERSION
        
        ## ÐÐ¾Ð²Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
        - Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð°Ð¼Ð¸ Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼Ð¸
        - Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÐµÐ»ÐµÐ¹
        - Ð’Ñ‹Ð´Ð°Ñ‡Ð° Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ ÐºÐ½Ð¸Ð³
        - ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²
        - Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
        - API Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
        
        ## Ð¢ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¸
        - FastAPI
        - SQLAlchemy
        - Pydantic
        - Docker
        
        ## Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
        \`\`\`bash
        ./install.sh
        \`\`\`
        EOF
        
        # ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼
        tar -czf library-system-$VERSION.tar.gz release/
    
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          library-system-$VERSION.tar.gz
          release/install.sh
          release/README.md
        body_path: release/CHANGELOG.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}